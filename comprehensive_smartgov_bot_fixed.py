#!/usr/bin/env python3
"""
Enhanced SmartGov Assistant Bot
Features:
- Card-based UI for all services
- Multilingual support (English, Hindi, Nepali)
- LLM-based intent detection
- Rule-based workflow management
- MULTI-USER CONCURRENT SUPPORT
"""
import asyncio
import aiohttp
import json
import time
import logging
import nest_asyncio
import pandas as pd
import csv
import os
import re
import threading
from collections import defaultdict
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, InputMediaPhoto
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, ContextTypes, filters
from config import Config
from PIL import Image, ImageDraw, ImageFont
import io

# Fix for Windows event loop issues
nest_asyncio.apply()

# Configure logging
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

class SmartGovAssistantBot:
    def __init__(self):
        """Initialize bot with configuration"""
        # Load configuration
        self.BOT_TOKEN = Config.BOT_TOKEN
        self.LLM_ENDPOINT = "http://localhost:11434/api/generate"
        self.MODEL_NAME = "qwen2"
        
        # Initialize states with thread-safe locks for concurrent access
        self.user_states = {}
        self.user_languages = {}
        self._state_lock = threading.RLock()  # Reentrant lock for state operations
        
        # Load workflow data
        self._load_workflow_data()
        
        # Initialize multilingual responses
        self._initialize_responses()
        
        logger.info("üîí MULTI-USER SUPPORT: Thread-safe state management initialized")

    def _get_user_state(self, user_id: int) -> dict:
        """Safely get user state with locking"""
        with self._state_lock:
            return self.user_states.get(user_id, {})

    def _set_user_state(self, user_id: int, state: dict):
        """Safely set user state with locking"""
        with self._state_lock:
            self.user_states[user_id] = state
            logger.info(f"üîí STATE UPDATE: User {user_id} ‚Üí {state.get('type', 'unknown')} stage {state.get('stage', 'unknown')}")

    def _clear_user_state(self, user_id: int):
        """Safely clear user state with locking"""
        with self._state_lock:
            if user_id in self.user_states:
                del self.user_states[user_id]
                logger.info(f"üßπ STATE CLEARED: User {user_id}")

    def get_user_state(self, user_id: int) -> dict:
        """Get user state"""
        return self._get_user_state(user_id)

    def set_user_state(self, user_id: int, state: dict):
        """Set user state"""
        self._set_user_state(user_id, state)

    def clear_user_state(self, user_id: int):
        """Clear user state"""
        self._clear_user_state(user_id)

    def _get_user_language(self, user_id: int) -> str:
        """Safely get user language with locking"""
        with self._state_lock:
            return self.user_languages.get(user_id, 'english')

    def _set_user_language(self, user_id: int, language: str):
        """Safely set user language with locking"""
        with self._state_lock:
            self.user_languages[user_id] = language
            logger.info(f"üåê LANGUAGE SET: User {user_id} ‚Üí {language.upper()}")

    def get_user_language(self, user_id: int) -> str:
        """Get user's preferred language"""
        return self._get_user_language(user_id)

    def set_user_language(self, user_id: int, language: str):
        """Set user's preferred language"""
        self._set_user_language(user_id, language)

    def _load_workflow_data(self):
        """Load all necessary data files"""
        # Load emergency services data
        with open('data/emergency_services_text_responses.json', 'r', encoding='utf-8') as f:
            self.emergency_data = json.load(f)
            
        # Load homestay data
        self.homestay_df = pd.read_csv('data/homestays_by_place.csv')
        
        # Load CSC contacts
        self.csc_df = pd.read_csv('data/csc_contacts.csv')
        
        # Load application status data
        self.status_df = pd.read_csv('data/status.csv')

    def _initialize_responses(self):
        """Initialize multilingual responses"""
        self.responses = {
            'hindi': {
                'main_menu': "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü‡§ó‡•â‡§µ ‡§Ö‡§∏‡§ø‡§∏‡•ç‡§ü‡•á‡§Ç‡§ü ‡§π‡•Ç‡§Å‡•§ ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•à‡§∏‡•á ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å?",
                'cancel_msg': "‚ùå ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡•Ä ‡§ó‡§à‡•§ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Ç ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç..."
            },
            'nepali': {
                'main_menu': "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü‡§ó‡§≠ ‡§Ö‡§∏‡§ø‡§∏‡•ç‡§ü‡•á‡§®‡•ç‡§ü ‡§π‡•Å‡§Å‡•§ ‡§Æ ‡§§‡§™‡§æ‡§à‡§Ç‡§≤‡§æ‡§à ‡§ï‡§∏‡§∞‡•Ä ‡§Æ‡§¶‡•ç‡§¶‡§§ ‡§ó‡§∞‡•ç‡§® ‡§∏‡§ï‡•ç‡§õ‡•Å?",
                'cancel_msg': "‚ùå ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§ó‡§∞‡§ø‡§Ø‡•ã‡•§ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Ç‡§Æ‡§æ ‡§´‡§∞‡•ç‡§ï‡§¶‡•à..."
            },
            'english': {
                'main_menu': "Hello! I'm the SmartGov Assistant. How can I help you?",
                'cancel_msg': "‚ùå Process cancelled. Returning to main menu..."
            }
        }

    async def get_intent_from_llm(self, message: str, language: str) -> str:
        """Get intent from LLM"""
        prompt = f"""
        Analyze the user's message and determine the intent.
        The possible intents are: 'disaster_management', 'emergency_services', 'tourism', 'csc', 'language', 'unknown'.
        User message: "{message}"
        Language: {language}
        Intent:
        """
        
        payload = {
            "model": self.MODEL_NAME,
            "prompt": prompt,
            "stream": False
        }
        
        try:
            async with aiohttp.ClientSession() as session:
                async with session.post(self.LLM_ENDPOINT, json=payload) as response:
                    if response.status == 200:
                        data = await response.json()
                        intent = data.get('response', '').strip().lower()
                        if intent in ['disaster_management', 'emergency_services', 'tourism', 'csc', 'language']:
                            return intent
        except Exception as e:
            logger.error(f"Error getting intent from LLM: {e}")
        return 'unknown'

    async def message_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Handle text messages"""
        message = update.message.text
        user_id = update.effective_user.id
        
        # Check for cancel/exit commands first (before any workflow processing)
        cancel_commands = [
            'cancel', 'exit', 'quit', 'stop', 'back', 'menu', 'home',
            'band karo', 'bandkaro', 'band kr', 'bandkar', 'cancel karo', 'cancel kar',
            '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•ã', '‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•ã', '‡§∞‡•ã‡§ï‡•ã', '‡§õ‡•ã‡§°‡§º‡•ã', '‡§µ‡§æ‡§™‡§∏', '‡§Æ‡•á‡§®‡•Ç', '‡§ò‡§∞',
            '‡§∞‡§¶‡•ç‡§¶ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç', '‡§¨‡§®‡•ç‡§¶ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç', '‡§∞‡•ã‡§ï‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç', '‡§õ‡•ã‡§°‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç', '‡§´‡§∞‡•ç‡§ï‡§®‡•Å‡§π‡•ã‡§∏‡•ç', '‡§Æ‡•á‡§®‡•Å', '‡§ò‡§∞'
        ]
        
        if any(cmd in message.lower() for cmd in cancel_commands):
            # Clear any existing user state
            self.clear_user_state(user_id)
            
            language = self.get_user_language(user_id)
            
            # Send cancellation confirmation message
            if language == 'hindi':
                cancel_msg = "‚ùå ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡•Ä ‡§ó‡§à‡•§ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Ç ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç..."
            elif language == 'nepali':
                cancel_msg = "‚ùå ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∞‡§¶‡•ç‡§¶ ‡§ó‡§∞‡§ø‡§Ø‡•ã‡•§ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Ç‡§Æ‡§æ ‡§´‡§∞‡•ç‡§ï‡§¶‡•à..."
            else:
                cancel_msg = "‚ùå Process cancelled. Returning to main menu..."
            
            await update.message.reply_text(cancel_msg)
            
            # Return to main menu
            await self.show_main_menu(update, context)
            return
        
        # If user is in a workflow, handle it
        user_state = self.get_user_state(user_id)
        if user_state:
            await self.handle_workflow_input(update, context, message, user_state)
            return
        
        # Get intent using LLM
        intent = await self.get_intent_from_llm(message, self.get_user_language(user_id))
        
        # Handle intent
        if intent == 'disaster_management':
            await self.handle_disaster_management(update, context)
        elif intent == 'emergency_services':
            await self.handle_emergency_services(update, context)
        elif intent == 'tourism':
            await self.handle_tourism(update, context)
        elif intent == 'csc':
            await self.handle_csc(update, context)
        elif intent == 'language':
            await self.start_command(update, context)
        else:
            await self.show_main_menu(update, context)

    async def handle_workflow_input(self, update: Update, context: ContextTypes.DEFAULT_TYPE, message: str, state: dict):
        """Handle user input in workflows"""
        workflow_type = state['type']
        
        if workflow_type == 'exgratia':
            await self.handle_exgratia_workflow(update, context, message, state)
        elif workflow_type == 'status':
            await self.handle_status_workflow(update, context, message, state)
        elif workflow_type == 'csc':
            await self.handle_csc_workflow(update, context, message, state)
        elif workflow_type == 'complaint':
            await self.handle_complaint_workflow(update, context, message, state)

    async def handle_place_selection(self, update: Update, context: ContextTypes.DEFAULT_TYPE, place: str):
        """Handle homestay place selection"""
        user_id = update.effective_user.id
        language = self.get_user_language(user_id)
        
        # Filter homestays by place
        homestays = self.homestay_df[self.homestay_df['Place'] == place]
        
        if homestays.empty:
            message = f"‚ùå No homestays found in {place}"
        else:
            if language == 'hindi':
                message = f"üè† **{place} ‡§Æ‡•á‡§Ç ‡§π‡•ã‡§Æ‡§∏‡•ç‡§ü‡•á**\n\n"
            elif language == 'nepali':
                message = f"üè† **{place} ‡§Æ‡§æ ‡§π‡•ã‡§Æ‡§∏‡•ç‡§ü‡•á**\n\n"
            else:
                message = f"üè† **Homestays in {place}**\n\n"
            
            for _, row in homestays.iterrows():
                message += f"*{row['HomestayName']}*\n"
                message += f"‚≠ê Rating: {row['Rating']}/5\n"
                message += f"üí∞ Price: ‚Çπ{row['PricePerNight']}/night\n"
                message += f"üìû Contact: {row['ContactNumber']}\n\n"
        
        keyboard = [
            [InlineKeyboardButton("üèîÔ∏è Search Another Place", callback_data="tourism")],
            [InlineKeyboardButton("üîô Back to Main", callback_data="back_main")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.callback_query.edit_message_text(
            text=message,
            reply_markup=reply_markup,
            parse_mode='Markdown'
        ) 

    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Handle /start command"""
        user_id = update.effective_user.id
        self.clear_user_state(user_id)
        
        keyboard = [
            [InlineKeyboardButton("English üá¨üáß", callback_data="lang_english")],
            [InlineKeyboardButton("‡§π‡§ø‡§®‡•ç‡§¶‡•Ä üáÆüá≥", callback_data="lang_hindi")],
            [InlineKeyboardButton("‡§®‡•á‡§™‡§æ‡§≤‡•Ä üá≥üáµ", callback_data="lang_nepali")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(
            "Welcome to the SmartGov Assistant! Please select your language:",
            reply_markup=reply_markup
        )

    async def handle_callback_query(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Handle callback queries from inline keyboards"""
        query = update.callback_query
        await query.answer()
        
        user_id = query.from_user.id
        data = query.data
        
        if data.startswith("lang_"):
            language = data.split("_")[1]
            self.set_user_language(user_id, language)
            await self.show_main_menu(update, context)
        elif data == "back_main":
            await self.show_main_menu(update, context)
        elif data == "disaster_management":
            await self.handle_disaster_management(update, context)
        elif data == "emergency_services":
            await self.handle_emergency_services(update, context)
        elif data == "tourism":
            await self.handle_tourism(update, context)
        elif data == "csc":
            await self.handle_csc(update, context)
        elif data.startswith("place_"):
            place = data.split("_")[1]
            await self.handle_place_selection(update, context, place)
        elif data.startswith("emergency_"):
            service = data.split("_")[1]
            await self.handle_emergency_response(update, context, service)

    async def show_main_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Show the main menu"""
        user_id = update.effective_user.id
        language = self.get_user_language(user_id)
        
        if language == 'hindi':
            text = "‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Ç:"
            keyboard = [
                [InlineKeyboardButton("‡§Ü‡§™‡§¶‡§æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® üå™Ô∏è", callback_data="disaster_management")],
                [InlineKeyboardButton("‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡•á‡§µ‡§æ‡§è‡§Ç üöë", callback_data="emergency_services")],
                [InlineKeyboardButton("‡§™‡§∞‡•ç‡§Ø‡§ü‡§® ‡§î‡§∞ ‡§π‡•ã‡§Æ‡§∏‡•ç‡§ü‡•á üèîÔ∏è", callback_data="tourism")],
                [InlineKeyboardButton("‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∏‡•á‡§µ‡§æ ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞ (CSC) üíª", callback_data="csc")],
                [InlineKeyboardButton("‡§≠‡§æ‡§∑‡§æ ‡§¨‡§¶‡§≤‡•á‡§Ç üåê", callback_data="lang_english")]
            ]
        elif language == 'nepali':
            text = "‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Å:"
            keyboard = [
                [InlineKeyboardButton("‡§µ‡§ø‡§™‡§¶‡•ç ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® üå™Ô∏è", callback_data="disaster_management")],
                [InlineKeyboardButton("‡§Ü‡§™‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡•á‡§µ‡§æ‡§π‡§∞‡•Ç üöë", callback_data="emergency_services")],
                [InlineKeyboardButton("‡§™‡§∞‡•ç‡§Ø‡§ü‡§® ‡§∞ ‡§π‡•ã‡§Æ‡§∏‡•ç‡§ü‡•á üèîÔ∏è", callback_data="tourism")],
                [InlineKeyboardButton("‡§∏‡§æ‡§ù‡§æ ‡§∏‡•á‡§µ‡§æ ‡§ï‡•á‡§®‡•ç‡§¶‡•ç‡§∞ (CSC) üíª", callback_data="csc")],
                [InlineKeyboardButton("‡§≠‡§æ‡§∑‡§æ ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§® ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç üåê", callback_data="lang_english")]
            ]
        else:
            text = "Main Menu:"
            keyboard = [
                [InlineKeyboardButton("Disaster Management üå™Ô∏è", callback_data="disaster_management")],
                [InlineKeyboardButton("Emergency Services üöë", callback_data="emergency_services")],
                [InlineKeyboardButton("Tourism & Homestays üèîÔ∏è", callback_data="tourism")],
                [InlineKeyboardButton("Common Service Centers (CSC) üíª", callback_data="csc")],
                [InlineKeyboardButton("Change Language üåê", callback_data="lang_english")]
            ]
            
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        if update.callback_query:
            await update.callback_query.edit_message_text(text, reply_markup=reply_markup)
        else:
            await update.message.reply_text(text, reply_markup=reply_markup)

    async def handle_disaster_management(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Handle disaster management"""
        user_id = update.effective_user.id
        language = self.get_user_language(user_id)
        
        if language == 'hindi':
            text = "‡§Ü‡§™‡§¶‡§æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§∏‡•á‡§µ‡§æ‡§è‡§Ç:"
            keyboard = [
                [InlineKeyboardButton("‡§è‡§ï‡•ç‡§∏-‡§ó‡•ç‡§∞‡•á‡§∂‡§ø‡§Ø‡§æ ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡•á‡§Ç", callback_data="exgratia_apply")],
                [InlineKeyboardButton("‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç", callback_data="status_check")],
                [InlineKeyboardButton("‡§Ü‡§™‡§¶‡§æ ‡§ï‡•Ä ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç", callback_data="report_disaster")],
                [InlineKeyboardButton("üîô ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Ç", callback_data="back_main")]
            ]
        elif language == 'nepali':
            text = "‡§µ‡§ø‡§™‡§¶‡•ç ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§∏‡•á‡§µ‡§æ‡§π‡§∞‡•Ç:"
            keyboard = [
                [InlineKeyboardButton("‡§è‡§ï‡•ç‡§∏-‡§ó‡•ç‡§∞‡•á‡§∂‡§ø‡§Ø‡§æ ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ‡§ï‡•ã ‡§≤‡§æ‡§ó‡§ø ‡§Ü‡§µ‡•á‡§¶‡§® ‡§¶‡§ø‡§®‡•Å‡§π‡•ã‡§∏‡•ç", callback_data="exgratia_apply")],
                [InlineKeyboardButton("‡§Ü‡§µ‡•á‡§¶‡§® ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ú‡§æ‡§Å‡§ö ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç", callback_data="status_check")],
                [InlineKeyboardButton("‡§µ‡§ø‡§™‡§¶‡•ç ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç", callback_data="report_disaster")],
                [InlineKeyboardButton("üîô ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Å", callback_data="back_main")]
            ]
        else:
            text = "Disaster Management Services:"
            keyboard = [
                [InlineKeyboardButton("Apply for Ex-gratia Assistance", callback_data="exgratia_apply")],
                [InlineKeyboardButton("Check Application Status", callback_data="status_check")],
                [InlineKeyboardButton("Report a Disaster", callback_data="report_disaster")],
                [InlineKeyboardButton("üîô Back to Main Menu", callback_data="back_main")]
            ]
            
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        if update.callback_query:
            await update.callback_query.edit_message_text(text, reply_markup=reply_markup)
        else:
            await update.message.reply_text(text, reply_markup=reply_markup)

    async def handle_emergency_services(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Handle emergency services"""
        user_id = update.effective_user.id
        language = self.get_user_language(user_id)
        
        if language == 'hindi':
            text = "‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡•á‡§µ‡§æ‡§è‡§Ç:"
            keyboard = [
                [InlineKeyboardButton("‡§™‡•Å‡§≤‡§ø‡§∏ üöì", callback_data="emergency_police")],
                [InlineKeyboardButton("‡§è‡§Æ‡•ç‡§¨‡•Å‡§≤‡•á‡§Ç‡§∏ üöë", callback_data="emergency_ambulance")],
                [InlineKeyboardButton("‡§´‡§æ‡§Ø‡§∞ ‡§¨‡•ç‡§∞‡§ø‡§ó‡•á‡§° üöí", callback_data="emergency_fire")],
                [InlineKeyboardButton("‡§Ü‡§™‡§¶‡§æ ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§¨‡§≤ üå™Ô∏è", callback_data="emergency_disaster")],
                [InlineKeyboardButton("üîô ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Ç", callback_data="back_main")]
            ]
        elif language == 'nepali':
            text = "‡§Ü‡§™‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡•á‡§µ‡§æ‡§π‡§∞‡•Ç:"
            keyboard = [
                [InlineKeyboardButton("‡§™‡•Å‡§≤‡§ø‡§∏ üöì", callback_data="emergency_police")],
                [InlineKeyboardButton("‡§è‡§Æ‡•ç‡§¨‡•Å‡§≤‡•á‡§®‡•ç‡§∏ üöë", callback_data="emergency_ambulance")],
                [InlineKeyboardButton("‡§¶‡§Æ‡§ï‡§≤ üöí", callback_data="emergency_fire")],
                [InlineKeyboardButton("‡§µ‡§ø‡§™‡§¶‡•ç ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§¨‡§≤ üå™Ô∏è", callback_data="emergency_disaster")],
                [InlineKeyboardButton("üîô ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Å", callback_data="back_main")]
            ]
        else:
            text = "Emergency Services:"
            keyboard = [
                [InlineKeyboardButton("Police üöì", callback_data="emergency_police")],
                [InlineKeyboardButton("Ambulance üöë", callback_data="emergency_ambulance")],
                [InlineKeyboardButton("Fire Brigade üöí", callback_data="emergency_fire")],
                [InlineKeyboardButton("Disaster Response Force üå™Ô∏è", callback_data="emergency_disaster")],
                [InlineKeyboardButton("üîô Back to Main Menu", callback_data="back_main")]
            ]
            
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        if update.callback_query:
            await update.callback_query.edit_message_text(text, reply_markup=reply_markup)
        else:
            await update.message.reply_text(text, reply_markup=reply_markup)

    async def handle_tourism(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Handle tourism"""
        user_id = update.effective_user.id
        language = self.get_user_language(user_id)
        
        if language == 'hindi':
            text = "‡§™‡§∞‡•ç‡§Ø‡§ü‡§® ‡§î‡§∞ ‡§π‡•ã‡§Æ‡§∏‡•ç‡§ü‡•á:"
            keyboard = [
                [InlineKeyboardButton("‡§ó‡§Ç‡§ó‡§ü‡•ã‡§ï", callback_data="place_Gangtok")],
                [InlineKeyboardButton("‡§™‡•á‡§≤‡§ø‡§Ç‡§ó", callback_data="place_Pelling")],
                [InlineKeyboardButton("‡§≤‡§æ‡§ö‡•Å‡§Ç‡§ó", callback_data="place_Lachung")],
                [InlineKeyboardButton("üîô ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Ç", callback_data="back_main")]
            ]
        elif language == 'nepali':
            text = "‡§™‡§∞‡•ç‡§Ø‡§ü‡§® ‡§∞ ‡§π‡•ã‡§Æ‡§∏‡•ç‡§ü‡•á:"
            keyboard = [
                [InlineKeyboardButton("‡§ó‡§æ‡§®‡•ç‡§§‡•ã‡§ï", callback_data="place_Gangtok")],
                [InlineKeyboardButton("‡§™‡•á‡§≤‡§ø‡§ô", callback_data="place_Pelling")],
                [InlineKeyboardButton("‡§≤‡§æ‡§ö‡•Å‡§ô", callback_data="place_Lachung")],
                [InlineKeyboardButton("üîô ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Å", callback_data="back_main")]
            ]
        else:
            text = "Tourism & Homestays:"
            keyboard = [
                [InlineKeyboardButton("Gangtok", callback_data="place_Gangtok")],
                [InlineKeyboardButton("Pelling", callback_data="place_Pelling")],
                [InlineKeyboardButton("Lachung", callback_data="place_Lachung")],
                [InlineKeyboardButton("üîô Back to Main Menu", callback_data="back_main")]
            ]
            
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        if update.callback_query:
            await update.callback_query.edit_message_text(text, reply_markup=reply_markup)
        else:
            await update.message.reply_text(text, reply_markup=reply_markup)

    async def handle_csc(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Handle CSC"""
        user_id = update.effective_user.id
        language = self.get_user_language(user_id)
        
        if language == 'hindi':
            text = "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∏‡•á‡§µ‡§æ ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞ (CSC):"
            keyboard = [
                [InlineKeyboardButton("‡§®‡§ø‡§ï‡§ü‡§§‡§Æ ‡§∏‡•Ä‡§è‡§∏‡§∏‡•Ä ‡§ñ‡•ã‡§ú‡•á‡§Ç", callback_data="csc_finder")],
                [InlineKeyboardButton("‡§∏‡•á‡§µ‡§æ‡§ì‡§Ç ‡§ï‡•Ä ‡§∏‡•Ç‡§ö‡•Ä", callback_data="csc_services")],
                [InlineKeyboardButton("üîô ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Ç", callback_data="back_main")]
            ]
        elif language == 'nepali':
            text = "‡§∏‡§æ‡§ù‡§æ ‡§∏‡•á‡§µ‡§æ ‡§ï‡•á‡§®‡•ç‡§¶‡•ç‡§∞ (CSC):"
            keyboard = [
                [InlineKeyboardButton("‡§®‡§ú‡§ø‡§ï‡§ï‡•ã ‡§∏‡•Ä‡§è‡§∏‡§∏‡•Ä ‡§ñ‡•ã‡§ú‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç", callback_data="csc_finder")],
                [InlineKeyboardButton("‡§∏‡•á‡§µ‡§æ‡§π‡§∞‡•Ç‡§ï‡•ã ‡§∏‡•Ç‡§ö‡•Ä", callback_data="csc_services")],
                [InlineKeyboardButton("üîô ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§®‡•Å", callback_data="back_main")]
            ]
        else:
            text = "Common Service Centers (CSC):"
            keyboard = [
                [InlineKeyboardButton("Find Nearest CSC", callback_data="csc_finder")],
                [InlineKeyboardButton("List of Services", callback_data="csc_services")],
                [InlineKeyboardButton("üîô Back to Main Menu", callback_data="back_main")]
            ]
            
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        if update.callback_query:
            await update.callback_query.edit_message_text(text, reply_markup=reply_markup)
        else:
            await update.message.reply_text(text, reply_markup=reply_markup)
            
    def run(self):
        """Run the bot"""
        async def main():
            app = Application.builder().token(self.BOT_TOKEN).build()

            # Command handlers
            app.add_handler(CommandHandler("start", self.start_command))

            # Message handlers
            app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.message_handler))

            # Callback query handlers
            app.add_handler(CallbackQueryHandler(self.handle_callback_query))

            print("üöÄ Starting Enhanced SmartGov Assistant Bot...")
            logger.info("ü§ñ Enhanced SmartGov Assistant is running...")
            
            # Initialize the bot
            await app.initialize()
            
            print(f"üì± Bot Link: https://t.me/{app.bot.username}")
            print("‚úÖ Ready to serve citizens!")
            
            # Start the bot
            await app.run_polling()

        asyncio.run(main())

if __name__ == '__main__':
    bot = SmartGovAssistantBot()
    bot.run() 